<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content="Skillera and APS Jodhpur Portal" />
    <title>Skillera | APS Jodhpur</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Supabase -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

    <!-- Google GenAI -->
    <script type="module">
      import { GoogleGenAI } from "https://esm.run/@google/genai";
      window.GoogleGenAI = GoogleGenAI;
    </script>
</head>
<body class="bg-slate-900 text-slate-200 font-sans antialiased">
    <div id="root"></div>

    <script type="text/babel">
      const { StrictMode, useState, useEffect, useRef, useCallback } = React;
      const { createRoot } = ReactDOM;

      // --- Supabase Client Setup ---
      const SUPABASE_URL = 'https://wpxommgyywoxnfjhcrpu.supabase.co';
      const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndweG9tbWd5eXdveG5mamhjcnB1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI0MDkyMDcsImV4cCI6MjA3Nzk4NTIwN30.3MCguuL1UwGuBZlK5WfggyPyWPBr5kh-9A_cMrcngCM';
      const { createClient } = supabase;
      const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
      
      // --- Helper for file upload ---
      const uploadFile = async (file, bucket, path) => {
        const { data, error } = await supabaseClient.storage.from(bucket).upload(path, file, {
            cacheControl: '3600',
            upsert: true,
        });
        if (error) throw error;
        
        const { data: { publicUrl } } = supabaseClient.storage.from(bucket).getPublicUrl(path);
        return publicUrl;
      };
      
      // --- Gamification Helpers ---
      const getPointsForLevel = (level) => {
          switch (level) {
              case 'International Level': return 100;
              case 'National Level': return 75;
              case 'State Level': return 50;
              case 'District Level': return 25;
              case 'Interhouse Level': return 10;
              default: return 0;
          }
      };

      const getBadgeForPoints = (points) => {
          if (points >= 500) return { name: 'Platinum', color: 'text-cyan-400', icon: 'üíé' };
          if (points >= 300) return { name: 'Gold', color: 'text-yellow-400', icon: 'ü•á' };
          if (points >= 150) return { name: 'Silver', color: 'text-slate-300', icon: 'ü•à' };
          if (points >= 50) return { name: 'Bronze', color: 'text-orange-400', icon: 'ü•â' };
          return null;
      };


      // --- New Login Options Modal ---
      const LoginOptionsModal = ({ isOpen, onClose, setView, setRole }) => {
          if (!isOpen) return null;

          const handleOptionClick = (view, role = null) => {
              setView(view);
              if (role) setRole(role);
              onClose(); // Close modal after selection
          };

          return (
              <div className="fixed inset-0 bg-black bg-opacity-75 flex justify-center items-center z-50 p-4" onClick={onClose}>
                  <div className="bg-slate-800 p-8 rounded-lg shadow-xl w-full max-w-sm text-center relative" onClick={e => e.stopPropagation()}>
                      <button onClick={onClose} className="absolute top-3 right-3 text-3xl font-bold text-slate-400 hover:text-white">&times;</button>
                      <h2 className="text-3xl font-bold mb-6 text-white">Login or Register</h2>
                      <div className="space-y-4">
                          <button onClick={() => handleOptionClick('login', 'student')} className="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition-colors duration-300 text-lg">
                              Login as Student
                          </button>
                          <button onClick={() => handleOptionClick('login', 'admin')} className="w-full bg-teal-500 hover:bg-teal-600 text-white font-bold py-3 px-4 rounded-lg transition-colors duration-300 text-lg">
                              Login as Admin
                          </button>
                          <button onClick={() => handleOptionClick('register')} className="w-full bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-4 rounded-lg transition-colors duration-300 text-lg">
                              Register Now
                          </button>
                      </div>
                  </div>
              </div>
          );
      };

      // --- School Website Components ---
      const SchoolHeader = ({ setView, setRole }) => {
          const loginDropdownItems = [
              { title: "Student Login", action: () => { setView('login'); setRole('student'); } },
              { title: "Admin Login", action: () => { setView('login'); setRole('admin'); } },
              { title: "Register to Skillera", action: () => { setView('register'); } }
          ];

          return (
              <header className="bg-slate-800 text-white shadow-lg sticky top-0 z-20">
                  <div className="container mx-auto flex justify-between items-center py-3 px-4">
                      <div className="text-xl md:text-2xl font-bold tracking-tight">
                          <a href="#">APS JODHPUR</a>
                      </div>
                      <div className="relative group">
                          <button className="bg-orange-500 hover:bg-orange-600 text-white font-bold py-2 px-5 rounded-md transition-colors duration-300 flex items-center space-x-2">
                              <span>Login</span>
                              <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 9l-7 7-7-7"></path></svg>
                          </button>
                          <div className="absolute top-full right-0 w-60 bg-slate-900 shadow-lg z-10 hidden group-hover:block rounded-md overflow-hidden mt-2">
                              <ul>
                                  {loginDropdownItems.map((subItem, index) => (
                                      <li key={index}>
                                          <button onClick={subItem.action} className="block w-full text-left px-6 py-3 text-sm transition-colors duration-200 whitespace-nowrap border-b border-slate-700/50 last:border-b-0 hover:bg-slate-700">
                                              ¬ª {subItem.title}
                                          </button>
                                      </li>
                                  ))}
                              </ul>
                          </div>
                      </div>
                  </div>
              </header>
          );
      };

      const SchoolHero = ({ onLoginClick }) => {
          const schoolImageUrl = "https://www.apsjodhpur.com/webdata/slider/6bdb8d0d5f3b595d3b341654b2a03f28.png";
          return (
            <div className="h-screen bg-cover bg-center relative flex items-center justify-center text-center" style={{ backgroundImage: `url(${schoolImageUrl})` }}>
              <div className="absolute inset-0 bg-black bg-opacity-30"></div>
              <div className="relative z-10 text-white p-4">
                  <h1 className="text-4xl md:text-6xl font-extrabold mb-4 drop-shadow-lg">Welcome to the Skillera Portal</h1>
                  <p className="text-lg md:text-2xl mb-8 max-w-2xl mx-auto drop-shadow-md">Showcase your achievements and skills. Login to get started.</p>
                  <button 
                      onClick={onLoginClick}
                      className="bg-orange-500 hover:bg-orange-600 text-white font-bold py-3 px-10 rounded-lg transition-transform duration-300 transform hover:scale-105 shadow-xl text-xl"
                  >
                      Login / Register
                  </button>
              </div>
            </div>
          );
      };
      
      const SchoolFooter = () => (<footer className="bg-slate-800 text-gray-400 py-8 text-center border-t border-slate-700"><p>&copy; 2024 APS Jodhpur. All Rights Reserved.</p></footer>);

      const SchoolWebsite = ({ setView, setRole }) => {
          const [isLoginModalOpen, setIsLoginModalOpen] = useState(false);

          return (
            <div className="bg-white text-slate-800">
                <SchoolHeader setView={setView} setRole={setRole} />
                <main>
                    <SchoolHero onLoginClick={() => setIsLoginModalOpen(true)} />
                    <section className="py-20 px-4 container mx-auto">
                        <h2 className="text-4xl font-bold mb-4 text-slate-900">About Our School</h2>
                        <p className="max-w-3xl text-lg text-gray-600">APS Jodhpur has been a beacon of learning and excellence since its inception. We are committed to providing a holistic education that fosters intellectual curiosity, critical thinking, and a love for learning. Our state-of-the-art campus and dedicated faculty provide a nurturing environment for students to thrive.</p>
                    </section>
                </main>
                <SchoolFooter />
                <LoginOptionsModal
                    isOpen={isLoginModalOpen}
                    onClose={() => setIsLoginModalOpen(false)}
                    setView={setView}
                    setRole={setRole}
                />
            </div>
          );
      };

      // --- Skillera Auth Components ---
      const AuthPage = ({ setView }) => {
        return (
            <div className="min-h-screen flex items-center justify-center">
                <div className="bg-slate-800 p-8 rounded-lg shadow-xl w-full max-w-md text-center">
                    <h1 className="text-3xl font-bold mb-2 text-white">Welcome to Skillera</h1>
                    <p className="text-slate-400 mb-6">Your gateway to skills and learning.</p>
                    <div className="mt-8">
                        <button onClick={() => setView('schoolHome')} className="w-full bg-teal-500 hover:bg-teal-600 text-white font-bold py-3 px-4 rounded-lg transition-colors duration-300 text-lg">
                            Get Started
                        </button>
                    </div>
                </div>
            </div>
        );
      };

      const LoginForm = ({ role, setView }) => {
        const [loading, setLoading] = useState(false);
        const [error, setError] = useState('');

        const handleSubmit = async (e) => {
            e.preventDefault();
            setLoading(true);
            setError('');
            const { email, password } = Object.fromEntries(new FormData(e.target));

            try {
                const { error } = await supabaseClient.auth.signInWithPassword({ email, password });
                if (error) throw error;
                // onAuthStateChange in App will handle navigation
            } catch (err) {
                setError(err.message);
            } finally {
                setLoading(false);
            }
        };

        return (
             <div className="min-h-screen flex items-center justify-center">
                <div className="bg-slate-800 p-8 rounded-lg shadow-xl w-full max-w-md">
                    <h2 className="text-2xl font-bold mb-6 text-center capitalize">{role} Login</h2>
                    <form onSubmit={handleSubmit} className="space-y-4">
                        <input type="email" name="email" placeholder="Email" className="w-full px-4 py-2 bg-slate-700 border border-slate-600 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required />
                        <input type="password" name="password" placeholder="Password" className="w-full px-4 py-2 bg-slate-700 border border-slate-600 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required />
                        {error && <p className="text-red-400 text-sm">{error}</p>}
                        <button type="submit" disabled={loading} className="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg transition-colors duration-300 disabled:bg-slate-600">
                            {loading ? 'Logging in...' : 'Login'}
                        </button>
                    </form>
                    <button onClick={() => setView('schoolHome')} className="mt-4 text-sm text-slate-400 hover:text-white">‚Üê Back to School Home</button>
                </div>
            </div>
        );
      }
      
       const RegisterForm = ({ setView }) => {
        const [loading, setLoading] = useState(false);
        const [error, setError] = useState('');

        const handleSubmit = async (e) => {
            e.preventDefault();
            setLoading(true);
            setError('');
            const { fullName, email, password } = Object.fromEntries(new FormData(e.target));
            
            try {
                const { data, error } = await supabaseClient.auth.signUp({
                    email,
                    password,
                    options: {
                        data: {
                            full_name: fullName,
                        }
                    }
                });
                if (error) throw error;
                alert('Registration successful! Please check your email to confirm your account, then log in.');
                setView('login');
            } catch (err) {
                setError(err.message);
            } finally {
                setLoading(false);
            }
        };

        return (
             <div className="min-h-screen flex items-center justify-center">
                <div className="bg-slate-800 p-8 rounded-lg shadow-xl w-full max-w-md">
                    <h2 className="text-2xl font-bold mb-6 text-center">Register</h2>
                    <form onSubmit={handleSubmit} className="space-y-4">
                        <input type="text" name="fullName" placeholder="Full Name" className="w-full px-4 py-2 bg-slate-700 border border-slate-600 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required />
                        <input type="email" name="email" placeholder="Email" className="w-full px-4 py-2 bg-slate-700 border border-slate-600 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required />
                        <input type="password" name="password" placeholder="Password" className="w-full px-4 py-2 bg-slate-700 border border-slate-600 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required />
                        {error && <p className="text-red-400 text-sm">{error}</p>}
                        <button type="submit" disabled={loading} className="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg transition-colors duration-300 disabled:bg-slate-600">
                           {loading ? 'Registering...' : 'Register'}
                        </button>
                    </form>
                    <button onClick={() => setView('schoolHome')} className="mt-4 text-sm text-slate-400 hover:text-white">‚Üê Back to School Home</button>
                </div>
            </div>
        );
      }
      
      // --- Student Components ---
      const AchievementModal = ({ isOpen, onClose, onSubmit, newAchievement, setNewAchievement, isSubmitting, error }) => {
          if (!isOpen) return null;
          
           const onInputChange = (e) => {
              const { name, value } = e.target;
              setNewAchievement(prev => ({ ...prev, [name]: value }));
          };

          const onFileChange = (e) => {
              const file = e.target.files?.[0] || null;
              if (file) {
                  const reader = new FileReader();
                  reader.onloadend = () => {
                      setNewAchievement(prev => ({ ...prev, proof: file, proofPreview: reader.result }));
                  };
                  reader.readAsDataURL(file);
              } else {
                  setNewAchievement(prev => ({ ...prev, proof: null, proofPreview: null }));
              }
          };

          return (
              <div className="fixed inset-0 bg-black bg-opacity-75 flex justify-center items-center z-50 p-4">
                  <div className="bg-slate-800 p-8 rounded-lg shadow-xl w-full max-w-lg relative max-h-[90vh] overflow-y-auto">
                      <button onClick={onClose} className="absolute top-3 right-3 text-3xl font-bold text-slate-400 hover:text-white">&times;</button>
                      <h2 className="text-2xl font-bold mb-6 text-center">Add Achievement</h2>
                      <form onSubmit={onSubmit} className="space-y-4">
                          <div>
                              <label htmlFor="name" className="block text-sm font-medium text-slate-300 mb-1">Name of Achievement</label>
                              <input type="text" id="name" name="name" value={newAchievement.name} onChange={onInputChange} placeholder="e.g., Won Gold in Science Olympiad" className="w-full px-4 py-2 bg-slate-700 border border-slate-600 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required />
                          </div>
                          <div>
                              <label htmlFor="type" className="block text-sm font-medium text-slate-300 mb-1">Type of Achievement</label>
                              <select id="type" name="type" value={newAchievement.type} onChange={onInputChange} className="w-full px-4 py-2 bg-slate-700 border border-slate-600 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                  <option>Academic</option> <option>Sports</option> <option>Cultural</option> <option>Arts</option> <option>Social Service</option> <option>Other</option>
                              </select>
                          </div>
                          <div>
                              <label htmlFor="level" className="block text-sm font-medium text-slate-300 mb-1">Level</label>
                              <select id="level" name="level" value={newAchievement.level} onChange={onInputChange} className="w-full px-4 py-2 bg-slate-700 border border-slate-600 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                  <option>Interhouse Level</option> <option>District Level</option> <option>State Level</option> <option>National Level</option> <option>International Level</option>
                              </select>
                          </div>
                          <div>
                              <label htmlFor="position" className="block text-sm font-medium text-slate-300 mb-1">Position in Competition</label>
                              <input type="text" id="position" name="position" value={newAchievement.position} onChange={onInputChange} placeholder="e.g., 1st Place, Runner-up, Finalist" className="w-full px-4 py-2 bg-slate-700 border border-slate-600 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" />
                          </div>
                           <div>
                              <label htmlFor="proof" className="block text-sm font-medium text-slate-300 mb-1">Upload Certificate or Proof</label>
                              <input type="file" id="proof" name="proof" onChange={onFileChange} className="w-full text-sm text-slate-400 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100" accept="image/png, image/jpeg, image/jpg, application/pdf" />
                          </div>
                           {newAchievement.proofPreview && (
                              <div className="mt-4">
                                  <p className="text-sm font-medium text-slate-300 mb-2">Proof Preview:</p>
                                  <img src={newAchievement.proofPreview} alt="Proof preview" className="rounded-md max-h-40 w-auto shadow-lg" />
                              </div>
                          )}
                          {error && <p className="text-red-400 text-sm bg-red-900/20 p-3 rounded-md">{error}</p>}
                          <button type="submit" disabled={isSubmitting} className="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg transition-colors duration-300 mt-4 disabled:bg-slate-600">
                            {isSubmitting ? 'Submitting...' : 'Add Achievement'}
                          </button>
                      </form>
                  </div>
              </div>
          );
      };
      
      const ProfileEditor = ({ profile, onProfileUpdate }) => {
          const fileInputRef = useRef(null);
          const [isSaving, setIsSaving] = useState(false);
          const [localProfile, setLocalProfile] = useState(profile);
          const [copied, setCopied] = useState(false);

          useEffect(() => {
              setLocalProfile(profile);
          }, [profile]);

          const portfolioUrl = `${window.location.origin}${window.location.pathname}?portfolio=${profile.id}`;

          const handleCopyLink = () => {
              navigator.clipboard.writeText(portfolioUrl).then(() => {
                  setCopied(true);
                  setTimeout(() => setCopied(false), 2500);
              });
          };

          const handlePictureClick = () => {
              fileInputRef.current.click();
          };

          const handleFileChange = (e) => {
              const file = e.target.files[0];
              if (file) {
                  const reader = new FileReader();
                  reader.onloadend = () => {
                      setLocalProfile(prev => ({ ...prev, avatar_url: reader.result, newAvatarFile: file }));
                  };
                  reader.readAsDataURL(file);
              }
          };

          const handleProfileChange = (e) => {
              const { name, value } = e.target;
              setLocalProfile(prev => ({...prev, [name]: value}));
          };

          const handleSaveChanges = async () => {
              setIsSaving(true);
              await onProfileUpdate(localProfile);
              setIsSaving(false);
              alert('Profile saved successfully!');
          };

          return (
              <div className="bg-slate-800 p-6 rounded-lg shadow-inner">
                  <h2 className="text-2xl font-semibold mb-6 border-b border-slate-700 pb-2">My Profile</h2>
                  <div className="grid grid-cols-1 md:grid-cols-3 gap-8 items-start">
                      <div className="flex flex-col items-center col-span-1">
                          <div className="w-32 h-32 rounded-full bg-slate-700 mb-4 overflow-hidden flex items-center justify-center">
                              {localProfile.avatar_url ? (
                                  <img src={localProfile.avatar_url} alt="Profile" className="w-full h-full object-cover" />
                              ) : (
                                  <svg className="w-20 h-20 text-slate-500" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fillRule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clipRule="evenodd"></path></svg>
                              )}
                          </div>
                          <input type="file" ref={fileInputRef} onChange={handleFileChange} className="hidden" accept="image/*" />
                          <button onClick={handlePictureClick} className="bg-slate-600 hover:bg-slate-500 text-white font-bold py-2 px-4 rounded-md text-sm">
                              Change Picture
                          </button>
                      </div>
                      <div className="col-span-1 md:col-span-2 space-y-4">
                          <div>
                              <label htmlFor="full_name" className="block text-sm font-medium text-slate-300 mb-1">Full Name</label>
                              <input type="text" id="full_name" name="full_name" value={localProfile.full_name || ''} onChange={handleProfileChange} className="w-full px-4 py-2 bg-slate-700 border border-slate-600 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" />
                          </div>
                           <div>
                              <label htmlFor="class" className="block text-sm font-medium text-slate-300 mb-1">Class & Section</label>
                              <input type="text" id="class" name="class" value={localProfile.class || ''} onChange={handleProfileChange} className="w-full px-4 py-2 bg-slate-700 border border-slate-600 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" />
                          </div>
                           <div>
                              <label htmlFor="skills" className="block text-sm font-medium text-slate-300 mb-1">My Skills & Interests</label>
                              <textarea id="skills" name="skills" value={localProfile.skills || ''} onChange={handleProfileChange} className="w-full px-4 py-2 bg-slate-700 border border-slate-600 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 h-24" placeholder="e.g., Piano, Football, Coding, Public Speaking..."></textarea>
                              <p className="text-xs text-slate-500 mt-1">Separate skills with a comma.</p>
                          </div>
                          <div className="pt-2">
                            <button onClick={handleSaveChanges} disabled={isSaving} className="w-full sm:w-auto bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-6 rounded-lg transition-colors duration-300 disabled:bg-slate-600">
                                {isSaving ? 'Saving...' : 'Save Profile'}
                            </button>
                          </div>
                      </div>
                  </div>
                  <div className="mt-10 bg-slate-700/50 p-4 rounded-lg border border-slate-600">
                      <label htmlFor="portfolio_url" className="block text-sm font-medium text-slate-300 mb-2">Your Public Portfolio Link</label>
                      <div className="flex gap-2">
                          <input
                              id="portfolio_url"
                              type="text"
                              value={portfolioUrl}
                              readOnly
                              className="w-full px-3 py-2 bg-slate-900/50 border border-slate-600 rounded-md focus:outline-none text-slate-400"
                          />
                          <button
                              onClick={handleCopyLink}
                              className="bg-teal-500 hover:bg-teal-600 text-white font-bold py-2 px-4 rounded-md text-sm transition-colors w-28 flex-shrink-0"
                          >
                              {copied ? 'Copied!' : 'Copy Link'}
                          </button>
                      </div>
                  </div>
              </div>
          );
      };

      const MyAchievementsList = ({ achievements, loading }) => {
            const [activeFilter, setActiveFilter] = useState('All');
            const [sortBy, setSortBy] = useState('newest');

            const getStatusBadge = (status) => {
              switch (status) {
                  case 'approved': return <div className="absolute top-4 right-4 text-xs font-bold py-1 px-3 rounded-full bg-green-500/20 text-green-300 border border-green-500/30">Approved</div>;
                  case 'rejected': return <div className="absolute top-4 right-4 text-xs font-bold py-1 px-3 rounded-full bg-red-500/20 text-red-300 border border-red-500/30">Rejected</div>;
                  case 'pending': return <div className="absolute top-4 right-4 text-xs font-bold py-1 px-3 rounded-full bg-yellow-500/20 text-yellow-300 border border-yellow-500/30">Pending</div>;
                  default: return null;
              }
            };

            const filteredAndSortedAchievements = achievements
                .filter(ach => {
                    if (activeFilter === 'All') return true;
                    return ach.status === activeFilter.toLowerCase();
                })
                .sort((a, b) => {
                    if (sortBy === 'newest') {
                        return new Date(b.created_at) - new Date(a.created_at);
                    } else { // oldest
                        return new Date(a.created_at) - new Date(b.created_at);
                    }
                });
            
            const FilterButton = ({ label }) => (
                <button
                    onClick={() => setActiveFilter(label)}
                    className={`px-4 py-2 text-sm font-semibold rounded-full transition-colors duration-200 ${activeFilter === label ? 'bg-blue-600 text-white' : 'bg-slate-700 hover:bg-slate-600'}`}
                >
                    {label}
                </button>
            );

            return (
             <div className="bg-slate-800 p-6 rounded-lg shadow-inner">
                 <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4 border-b border-slate-700 pb-4">
                    <div>
                        <h2 className="text-2xl font-semibold">My Achievements</h2>
                        <p className="text-slate-400 text-sm mt-1">View and manage your submissions.</p>
                    </div>
                    <div className="flex flex-wrap items-center gap-2">
                        <FilterButton label="All" />
                        <FilterButton label="Pending" />
                        <FilterButton label="Approved" />
                        <FilterButton label="Rejected" />
                    </div>
                     <div>
                        <label htmlFor="sort-achievements" className="sr-only">Sort by</label>
                        <select
                            id="sort-achievements"
                            value={sortBy}
                            onChange={(e) => setSortBy(e.target.value)}
                            className="bg-slate-700 border border-slate-600 rounded-md text-sm px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                        >
                            <option value="newest">Newest First</option>
                            <option value="oldest">Oldest First</option>
                        </select>
                     </div>
                </div>
                 {loading ? <p>Loading achievements...</p> : filteredAndSortedAchievements.length > 0 ? (
                     <div className="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6">
                        {filteredAndSortedAchievements.map(ach => (
                         <div key={ach.id} className="bg-slate-900/70 p-6 rounded-xl border border-slate-700/50 hover:border-teal-500/50 transition-all duration-300 shadow-lg hover:shadow-teal-500/10 relative flex flex-col">
                            {getStatusBadge(ach.status)}
                            <div className="flex-grow">
                                <h3 className="font-bold text-xl text-white mb-2 pr-20">{ach.name}</h3>
                                {ach.status === 'approved' && getPointsForLevel(ach.level) > 0 && 
                                    <div className="font-bold text-teal-400 mb-2">+{getPointsForLevel(ach.level)} Points</div>
                                }
                                <div className="flex items-center flex-wrap gap-2 text-sm mb-4">
                                  <span className="inline-block bg-blue-500/20 text-blue-300 px-2.5 py-1 rounded-full text-xs font-semibold">{ach.type}</span>
                                  <span className="inline-block bg-purple-500/20 text-purple-300 px-2.5 py-1 rounded-full text-xs font-semibold">{ach.level}</span>
                                </div>
                                {ach.position && <p className="text-slate-400 mb-4">Position: <span className="font-semibold text-slate-300">{ach.position}</span></p>}
                            </div>
                            {ach.proof_url && (
                                <a href={ach.proof_url} target="_blank" rel="noopener noreferrer" className="inline-block mt-auto bg-slate-700 hover:bg-slate-600 text-white font-semibold py-2 px-4 rounded-md text-sm transition-colors text-center">
                                    View Proof
                                </a>
                            )}
                         </div>
                        ))}
                     </div>
                 ) : <p className="text-slate-400 py-8 text-center bg-slate-900/50 rounded-lg">No achievements match your current filter. Try selecting "All".</p>}
             </div>
            );
          };

      const QuizComponent = () => {
        const [quizView, setQuizView] = useState('home'); // home, active, results
        const [topic, setTopic] = useState('');
        const [quizQuestions, setQuizQuestions] = useState([]);
        const [userAnswers, setUserAnswers] = useState({});
        const [score, setScore] = useState(0);
        const [generationError, setGenerationError] = useState('');
        const [isGenerating, setIsGenerating] = useState(false);

        // Gemini JSON Schema Enum Helper
        const Type = { STRING: 'STRING', NUMBER: 'NUMBER', INTEGER: 'INTEGER', BOOLEAN: 'BOOLEAN', ARRAY: 'ARRAY', OBJECT: 'OBJECT' };
        
        const handleGenerateQuiz = async (e) => {
            e.preventDefault();
            if (!topic.trim()) {
                setGenerationError("Please enter a topic.");
                return;
            }
            setIsGenerating(true);
            setGenerationError('');
            
            try {
                if (!window.GoogleGenAI) throw new Error("Gemini AI library not loaded.");
                const ai = new window.GoogleGenAI({ apiKey: process.env.API_KEY });
                const prompt = `You are an expert educator who creates engaging quizzes for students. Generate a 5-question multiple-choice quiz on the topic of "${topic}". Each question must have exactly four options. Ensure the correct answer is one of the provided options. Provide your response strictly in the JSON format defined by the schema.`;
                
                const quizSchema = {
                    type: Type.OBJECT,
                    properties: {
                        quiz: {
                            type: Type.ARRAY,
                            items: {
                                type: Type.OBJECT,
                                properties: {
                                    question: { type: Type.STRING },
                                    options: { type: Type.ARRAY, items: { type: Type.STRING } },
                                    correctAnswer: { type: Type.STRING }
                                },
                                required: ['question', 'options', 'correctAnswer']
                            }
                        }
                    },
                    required: ['quiz']
                };

                const response = await ai.models.generateContent({
                    model: "gemini-2.5-flash",
                    contents: prompt,
                    config: { responseMimeType: "application/json", responseSchema: quizSchema },
                });

                const parsedResponse = JSON.parse(response.text);
                if (parsedResponse.quiz && parsedResponse.quiz.length > 0) {
                    setQuizQuestions(parsedResponse.quiz);
                    setQuizView('active');
                } else {
                    throw new Error("AI did not return a valid quiz. Please try a different topic.");
                }
            } catch(e) {
                console.error("Quiz generation failed:", e.message);
                setGenerationError(e.message || "Failed to generate quiz. The topic might be too broad or too specific. Please try again.");
                setQuizView('home');
            } finally {
                setIsGenerating(false);
            }
        };

        const handleAnswerSelect = (questionIndex, answer) => {
            setUserAnswers(prev => ({ ...prev, [questionIndex]: answer }));
        };
        
        const handleSubmitQuiz = () => {
            let currentScore = 0;
            quizQuestions.forEach((q, index) => {
                if (userAnswers[index] === q.correctAnswer) {
                    currentScore++;
                }
            });
            setScore(currentScore);
            setQuizView('results');
        };
        
        const handleResetQuiz = () => {
            setQuizView('home');
            setTopic('');
            setQuizQuestions([]);
            setUserAnswers({});
            setScore(0);
            setGenerationError('');
        };

        const renderContent = () => {
            if (isGenerating) {
                return (
                    <div className="text-center py-10">
                        <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-teal-400 mx-auto"></div>
                        <p className="mt-4 text-lg font-semibold text-slate-300">Generating your quiz on "{topic}"...</p>
                        <p className="text-slate-400">Please wait a moment.</p>
                    </div>
                );
            }

            switch(quizView) {
                case 'home': return (
                    <div className="max-w-xl mx-auto text-center">
                        <h3 className="text-2xl font-semibold mb-2 text-white">AI-Powered Quiz Generator</h3>
                        <p className="text-slate-400 mb-6">Enter any topic to generate a practice quiz and test your knowledge.</p>
                        <form onSubmit={handleGenerateQuiz} className="space-y-4">
                            <input
                                type="text"
                                value={topic}
                                onChange={(e) => setTopic(e.target.value)}
                                placeholder="e.g., Photosynthesis, The Mughal Empire, Quadratic Equations..."
                                className="w-full px-4 py-3 bg-slate-700 border border-slate-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-lg"
                                disabled={isGenerating}
                            />
                            {generationError && <p className="text-red-400 text-sm bg-red-900/20 p-3 rounded-md">{generationError}</p>}
                            <button type="submit" disabled={isGenerating || !topic.trim()} className="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition-colors duration-300 text-lg disabled:bg-slate-600 disabled:cursor-not-allowed">
                                {isGenerating ? 'Generating...' : 'Generate Quiz'}
                            </button>
                        </form>
                    </div>
                );
                case 'active': return (
                    <div>
                        <h3 className="text-xl font-semibold mb-6 text-center">Quiz on: {topic}</h3>
                        <div className="space-y-8">
                            {quizQuestions.map((q, qIndex) => (
                                <div key={qIndex} className="bg-slate-700/50 p-6 rounded-lg">
                                    <p className="font-bold text-lg mb-4">{qIndex + 1}. {q.question}</p>
                                    <div className="space-y-3">
                                        {q.options.map((opt, oIndex) => (
                                            <label key={oIndex} className={`block p-3 rounded-md cursor-pointer transition-colors ${userAnswers[qIndex] === opt ? 'bg-blue-600' : 'bg-slate-600 hover:bg-slate-500'}`}>
                                                <input type="radio" name={`q-${qIndex}`} value={opt} onChange={() => handleAnswerSelect(qIndex, opt)} className="mr-3" checked={userAnswers[qIndex] === opt} />
                                                {opt}
                                            </label>
                                        ))}
                                    </div>
                                </div>
                            ))}
                        </div>
                        <button onClick={handleSubmitQuiz} className="w-full mt-8 bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-4 rounded-lg transition-colors duration-300">Submit Quiz</button>
                    </div>
                );
                case 'results': return (
                     <div>
                        <h2 className="text-3xl font-bold mb-4 text-center">Quiz Results</h2>
                        <p className="text-2xl font-semibold text-center mb-8 text-teal-400">You scored {score} out of {quizQuestions.length}!</p>
                        <div className="space-y-6">
                             {quizQuestions.map((q, qIndex) => {
                                const userAnswer = userAnswers[qIndex];
                                const isCorrect = userAnswer === q.correctAnswer;
                                return (
                                <div key={qIndex} className={`p-4 rounded-lg border-l-4 ${isCorrect ? 'border-green-500 bg-green-500/10' : 'border-red-500 bg-red-500/10'}`}>
                                    <p className="font-bold mb-2">{qIndex + 1}. {q.question}</p>
                                    <p className="text-sm">Your answer: <span className={`font-semibold ${isCorrect ? 'text-green-300' : 'text-red-300'}`}>{userAnswer || "Not answered"}</span></p>
                                    {!isCorrect && <p className="text-sm">Correct answer: <span className="font-semibold text-green-300">{q.correctAnswer}</span></p>}
                                </div>
                                )
                            })}
                        </div>
                        <button onClick={handleResetQuiz} className="w-full mt-8 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition-colors duration-300">Try Another Quiz</button>
                    </div>
                );
                default: return <p>Something went wrong.</p>;
            }
        };

        return (
            <div className="bg-slate-800 p-8 rounded-lg shadow-inner">
                {renderContent()}
            </div>
        );
      };
      
      const RecommendationsComponent = ({ profile, setActiveView }) => {
          const [recommendations, setRecommendations] = useState([]);
          const [isLoading, setIsLoading] = useState(false);
          const [error, setError] = useState('');

          const hasSkills = profile && profile.skills && profile.skills.trim().length > 0;
          const Type = { STRING: 'STRING', NUMBER: 'NUMBER', INTEGER: 'INTEGER', BOOLEAN: 'BOOLEAN', ARRAY: 'ARRAY', OBJECT: 'OBJECT' };

          const handleGenerate = async () => {
              setIsLoading(true);
              setError('');
              setRecommendations([]);

              try {
                  if (!window.GoogleGenAI) throw new Error("Gemini AI library not loaded.");
                  const ai = new window.GoogleGenAI({ apiKey: process.env.API_KEY });

                  const prompt = `I am a student with the following skills and interests: ${profile.skills}. Generate a list of 5-7 diverse recommendations to help me grow. Include online courses, competitions, useful websites, and project ideas. Provide the response strictly in the JSON format defined by the schema.`;

                  const recSchema = {
                      type: Type.OBJECT,
                      properties: {
                          recommendations: {
                              type: Type.ARRAY,
                              items: {
                                  type: Type.OBJECT,
                                  properties: {
                                      category: { type: Type.STRING, description: "E.g., Online Course, Competition, Project Idea, Website, Book" },
                                      title: { type: Type.STRING },
                                      description: { type: Type.STRING },
                                      url: { type: Type.STRING, description: "A relevant URL, if applicable." }
                                  },
                                  required: ['category', 'title', 'description']
                              }
                          }
                      },
                      required: ['recommendations']
                  };

                  const response = await ai.models.generateContent({
                      model: "gemini-2.5-flash",
                      contents: prompt,
                      config: { responseMimeType: "application/json", responseSchema: recSchema },
                  });

                  const parsedResponse = JSON.parse(response.text);
                  if (parsedResponse.recommendations && parsedResponse.recommendations.length > 0) {
                      setRecommendations(parsedResponse.recommendations);
                  } else {
                      throw new Error("The AI did not return any recommendations. Try refining your skills in your profile.");
                  }
              } catch(e) {
                  console.error("Recommendation generation failed:", e);
                  setError(e.message || "Failed to generate recommendations. Please try again later.");
              } finally {
                  setIsLoading(false);
              }
          };

          if (!hasSkills) {
              return (
                  <div className="text-center bg-slate-800 p-8 rounded-lg shadow-inner">
                      <h2 className="text-2xl font-semibold mb-4">Unlock Your Potential</h2>
                      <p className="text-slate-400 mb-6 max-w-lg mx-auto">Add your skills and interests to your profile to receive personalized recommendations for courses, competitions, and more.</p>
                      <button onClick={() => setActiveView('profile')} className="bg-teal-500 hover:bg-teal-600 text-white font-bold py-2 px-6 rounded-lg transition-colors">
                          Go to My Profile
                      </button>
                  </div>
              );
          }

          return (
              <div className="bg-slate-800 p-8 rounded-lg shadow-inner">
                  <h2 className="text-2xl font-semibold mb-2">Personalized Recommendations</h2>
                  <p className="text-slate-400 mb-6">Based on your skills: <span className="font-semibold text-teal-400">{profile.skills}</span></p>

                  <div className="text-center mb-8">
                      <button onClick={handleGenerate} disabled={isLoading} className="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-lg transition-colors duration-300 disabled:bg-slate-600 disabled:cursor-not-allowed text-lg">
                          {isLoading ? 'Generating...' : '‚ú® Generate New Recommendations'}
                      </button>
                  </div>

                  {isLoading && (
                       <div className="text-center py-10">
                          <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-teal-400 mx-auto"></div>
                          <p className="mt-4 text-lg font-semibold text-slate-300">Finding the best opportunities for you...</p>
                       </div>
                  )}

                  {error && <p className="text-red-400 text-center bg-red-900/20 p-3 rounded-md">{error}</p>}

                  {recommendations.length > 0 && (
                      <div className="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6">
                          {recommendations.map((rec, index) => (
                              <div key={index} className="bg-slate-900/70 p-6 rounded-xl border border-slate-700/50 flex flex-col">
                                  <span className="inline-block bg-purple-500/20 text-purple-300 px-2.5 py-1 rounded-full text-xs font-semibold self-start mb-3">{rec.category}</span>
                                  <h3 className="font-bold text-xl text-white mb-2 flex-grow">{rec.title}</h3>
                                  <p className="text-slate-400 text-sm mb-4">{rec.description}</p>
                                  {rec.url && (
                                      <a href={rec.url} target="_blank" rel="noopener noreferrer" className="inline-block mt-auto bg-slate-700 hover:bg-slate-600 text-white font-semibold py-2 px-4 rounded-md text-sm transition-colors text-center">
                                          Learn More
                                      </a>
                                  )}
                              </div>
                          ))}
                      </div>
                  )}
              </div>
          );
      };

      const StudentDashboard = ({ session, profile, handleLogout, updateProfile }) => {
          const [isModalOpen, setIsModalOpen] = useState(false);
          const [activeView, setActiveView] = useState('dashboard'); // Main dashboard view
          const [myAchievements, setMyAchievements] = useState([]);
          const [loading, setLoading] = useState(true);
          const [isSubmitting, setIsSubmitting] = useState(false);
          const [submissionError, setSubmissionError] = useState('');

          const initialAchievementState = { name: '', type: 'Academic', level: 'Interhouse Level', position: '', proof: null, proofPreview: null };
          const [newAchievement, setNewAchievement] = useState(initialAchievementState);
          
          const fetchAchievements = useCallback(async () => {
              setLoading(true);
              const { data, error } = await supabaseClient
                  .from('achievements')
                  .select('*')
                  .eq('student_id', session.user.id)
                  .order('created_at', { ascending: false });

              if (error) console.error('Error fetching achievements:', error.message);
              else setMyAchievements(data);
              setLoading(false);
          }, [session.user.id]);

          useEffect(() => {
              if (activeView === 'achievements' || activeView === 'dashboard' || activeView === 'leaderboard') {
                fetchAchievements();
              }
          }, [fetchAchievements, activeView]);

          const handleSubmit = async (e) => {
              e.preventDefault();
              if (newAchievement.name.trim()) {
                  setIsSubmitting(true);
                  setSubmissionError('');
                  try {
                      let proofUrl = null;
                      if (newAchievement.proof) {
                          const filePath = `${session.user.id}/${Date.now()}_${newAchievement.proof.name}`;
                          proofUrl = await uploadFile(newAchievement.proof, 'uploads', filePath);
                      }
                      const points = getPointsForLevel(newAchievement.level);
                      const { error } = await supabaseClient.from('achievements').insert({
                          student_id: session.user.id,
                          name: newAchievement.name,
                          type: newAchievement.type,
                          level: newAchievement.level,
                          position: newAchievement.position,
                          proof_url: proofUrl,
                          status: 'pending',
                          points: points,
                      });
                      if (error) throw error;
                      
                      await fetchAchievements();
                      setNewAchievement(initialAchievementState);
                      setIsModalOpen(false);
                      setActiveView('achievements');
                  } catch (error) {
                      setSubmissionError(`Failed to add achievement: ${error.message}. Please try again.`);
                  } finally {
                      setIsSubmitting(false);
                  }
              }
          };
          
          const ProgressChart = ({ achievements }) => {
              const approvedAchievements = achievements.filter(a => a.status === 'approved');
              const data = approvedAchievements.reduce((acc, ach) => {
                  acc[ach.type] = (acc[ach.type] || 0) + 1;
                  return acc;
              }, {});
              const total = approvedAchievements.length;
              if (total === 0) return <div className="text-center text-slate-500">No approved achievements to display.</div>;

              const colors = ['#34D399', '#60A5FA', '#FBBF24', '#A78BFA', '#F472B6', '#FB923C'];
              const radius = 80;
              const circumference = 2 * Math.PI * radius;
              
              let accumulatedOffset = 0;
              const segments = Object.entries(data).map(([type, count], index) => {
                  const percentage = (count / total) * 100;
                  const strokeDashoffset = circumference - (accumulatedOffset / 100 * circumference);
                  accumulatedOffset += percentage;
                  return {
                      type,
                      count,
                      percentage: percentage.toFixed(1),
                      color: colors[index % colors.length],
                      strokeDashoffset,
                      strokeDasharray: `${circumference} ${circumference}`,
                  };
              });

              return (
                <div className="flex flex-col md:flex-row items-center gap-8">
                  <div className="relative w-48 h-48">
                    <svg className="w-full h-full" viewBox="0 0 200 200">
                      <circle cx="100" cy="100" r={radius} fill="none" stroke="#475569" strokeWidth="20" />
                      {segments.map(seg => (
                        <circle
                          key={seg.type}
                          cx="100"
                          cy="100"
                          r={radius}
                          fill="none"
                          stroke={seg.color}
                          strokeWidth="20"
                          strokeDasharray={seg.strokeDasharray}
                          strokeDashoffset={seg.strokeDashoffset}
                          transform="rotate(-90 100 100)"
                          className="transition-all duration-500"
                        />
                      ))}
                    </svg>
                    <div className="absolute inset-0 flex flex-col items-center justify-center">
                       <span className="text-4xl font-extrabold text-white">{total}</span>
                       <span className="text-sm text-slate-400">Total</span>
                    </div>
                  </div>
                  <div className="flex-1">
                    <ul className="space-y-2">
                        {segments.map(seg => (
                          <li key={seg.type} className="flex items-center justify-between text-sm">
                            <div className="flex items-center gap-2">
                              <span className="w-3 h-3 rounded-full" style={{ backgroundColor: seg.color }}></span>
                              <span className="text-slate-300">{seg.type}</span>
                            </div>
                            <span className="font-semibold text-white">{seg.count} ({seg.percentage}%)</span>
                          </li>
                        ))}
                    </ul>
                  </div>
                </div>
              );
          };

          const DashboardHome = () => {
             const totalPoints = myAchievements.filter(a => a.status === 'approved').reduce((sum, a) => sum + getPointsForLevel(a.level), 0);
             const badge = getBadgeForPoints(totalPoints);
             return (
             <div className="space-y-8">
                <div className="bg-slate-800 p-8 rounded-lg shadow-inner">
                    <div className="flex items-center justify-between">
                        <div>
                            <h2 className="text-3xl font-bold mb-2">Welcome back, {profile.full_name}!</h2>
                            <p className="text-slate-400 text-lg">This is your personal dashboard to track skills, achievements, and more.</p>
                        </div>
                        {badge && (
                            <div className="text-center">
                                <span className="text-5xl">{badge.icon}</span>
                                <div className={`font-bold ${badge.color}`}>{badge.name} Badge</div>
                            </div>
                        )}
                    </div>
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mt-8">
                        <div className="bg-slate-700/50 p-6 rounded-lg">
                            <h3 className="font-bold text-lg text-teal-400">Total Points</h3>
                            <p className="text-4xl font-extrabold text-white mt-2">{totalPoints}</p>
                        </div>
                        <div className="bg-slate-700/50 p-6 rounded-lg">
                            <h3 className="font-bold text-lg text-green-400">Approved Achievements</h3>
                            <p className="text-4xl font-extrabold text-white mt-2">{myAchievements.filter(a => a.status === 'approved').length}</p>
                        </div>
                        <div className="bg-slate-700/50 p-6 rounded-lg">
                            <h3 className="font-bold text-lg text-yellow-400">Pending Submissions</h3>
                            <p className="text-4xl font-extrabold text-white mt-2">{myAchievements.filter(a => a.status === 'pending').length}</p>
                        </div>
                         <div className="bg-slate-700/50 p-6 rounded-lg">
                            <h3 className="font-bold text-lg text-blue-400">Total Achievements</h3>
                            <p className="text-4xl font-extrabold text-white mt-2">{myAchievements.length}</p>
                        </div>
                    </div>
                </div>
                <div className="bg-slate-800 p-8 rounded-lg shadow-inner">
                    <h2 className="text-2xl font-semibold mb-6">Progress Tracking</h2>
                    <ProgressChart achievements={myAchievements} />
                </div>
              </div>
            );
          };
          
          const LeaderboardComponent = () => {
              const [leaderboard, setLeaderboard] = useState([]);
              const [loading, setLoading] = useState(true);

              useEffect(() => {
                  const fetchLeaderboardData = async () => {
                      setLoading(true);
                      const { data: profilesData, error: profilesError } = await supabaseClient
                          .from('profiles')
                          .select('id, full_name, class, avatar_url')
                          .eq('role', 'student');

                      if (profilesError) {
                          console.error("Error fetching profiles:", profilesError.message);
                          setLoading(false);
                          return;
                      }

                      const { data: achievementsData, error: achievementsError } = await supabaseClient
                          .from('achievements')
                          .select('student_id, level')
                          .eq('status', 'approved');

                      if (achievementsError) {
                          console.error("Error fetching achievements:", achievementsError.message);
                          setLoading(false);
                          return;
                      }
                      
                      const pointsMap = achievementsData.reduce((acc, ach) => {
                          acc[ach.student_id] = (acc[ach.student_id] || 0) + getPointsForLevel(ach.level);
                          return acc;
                      }, {});

                      const leaderboardData = profilesData
                          .map(profile => ({
                              ...profile,
                              points: pointsMap[profile.id] || 0,
                          }))
                          .sort((a, b) => b.points - a.points);

                      setLeaderboard(leaderboardData);
                      setLoading(false);
                  };

                  fetchLeaderboardData();
              }, []);

              const rankIcons = ['ü•á', 'ü•à', 'ü•â'];
              
              if (loading) return <p>Loading leaderboard...</p>;

              return (
                  <div className="bg-slate-800 p-6 rounded-lg shadow-inner">
                      <div className="overflow-x-auto">
                          <table className="w-full text-left">
                              <thead>
                                  <tr className="border-b border-slate-700">
                                      <th className="p-4 w-16 text-center">Rank</th>
                                      <th className="p-4">Student</th>
                                      <th className="p-4">Class</th>
                                      <th className="p-4 text-right">Points</th>
                                  </tr>
                              </thead>
                              <tbody>
                                  {leaderboard.map((student, index) => {
                                      const badge = getBadgeForPoints(student.points);
                                      const isCurrentUser = student.id === session.user.id;
                                      return (
                                          <tr key={student.id} className={`border-b border-slate-700/50 ${isCurrentUser ? 'bg-blue-900/50' : 'hover:bg-slate-700/30'}`}>
                                              <td className="p-4 text-center font-bold text-xl">{rankIcons[index] || index + 1}</td>
                                              <td className="p-4 flex items-center gap-4">
                                                  <img src={student.avatar_url || `https://ui-avatars.com/api/?name=${student.full_name}&background=0F172A&color=fff`} alt="Avatar" className="w-10 h-10 rounded-full object-cover"/>
                                                  <div>
                                                      <div className="font-semibold text-white">{student.full_name}</div>
                                                      {badge && <div className={`text-xs font-bold ${badge.color}`}>{badge.name}</div>}
                                                  </div>
                                              </td>
                                              <td className="p-4 text-slate-400">{student.class || 'N/A'}</td>
                                              <td className="p-4 text-right font-bold text-teal-400 text-lg">{student.points}</td>
                                          </tr>
                                      );
                                  })}
                              </tbody>
                          </table>
                      </div>
                  </div>
              );
          };

          const NotificationsComponent = () => {
              const [notifications, setNotifications] = useState([]);
              const [loading, setLoading] = useState(true);

              useEffect(() => {
                  setLoading(true);
                  // Mock notifications since the database table might not exist, preventing errors.
                  const mockNotifications = [
                      { id: 1, title: 'Annual Sports Day Announced!', content: 'Get ready for the annual sports day on the 15th of next month. Sign-ups are open now in the office.', created_at: new Date().toISOString() },
                      { id: 2, title: 'Science Olympiad Registration Open', content: 'The registration for the National Science Olympiad is now open. Please contact your science teacher for more details.', created_at: new Date(Date.now() - 86400000).toISOString() },
                  ];
                  setNotifications(mockNotifications);
                  setLoading(false);
              }, []);

              if (loading) return <p>Loading notifications...</p>;
              
              return (
                  <div className="bg-slate-800 p-6 rounded-lg shadow-inner">
                      {notifications.length > 0 ? (
                          <div className="space-y-6">
                              {notifications.map(notif => (
                                  <div key={notif.id} className="bg-slate-900/70 p-6 rounded-xl border border-slate-700/50">
                                      <div className="flex justify-between items-start">
                                          <h3 className="font-bold text-xl text-teal-400 mb-2">{notif.title}</h3>
                                          <p className="text-sm text-slate-500">{new Date(notif.created_at).toLocaleDateString()}</p>
                                      </div>
                                      <p className="text-slate-300 whitespace-pre-wrap">{notif.content}</p>
                                  </div>
                              ))}
                          </div>
                      ) : (
                          <p className="text-center text-slate-500 py-8">No notifications yet.</p>
                      )}
                  </div>
              );
          };


          const NavItem = ({ icon, label, viewName, isAction = false, action = () => {} }) => (
            <li>
                <button 
                    onClick={() => isAction ? action() : setActiveView(viewName)} 
                    className={`w-full flex items-center space-x-3 px-4 py-3 rounded-lg text-left transition-colors duration-200 ${activeView === viewName ? 'bg-blue-600 text-white shadow-lg' : 'text-slate-300 hover:bg-slate-700/50 hover:text-white'}`}
                >
                    {icon}
                    <span className="font-medium">{label}</span>
                </button>
            </li>
          );
          
          const icons = {
              dashboard: <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"></path></svg>,
              add: <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>,
              achievements: <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 19V6l1.293-1.293a1 1 0 011.414 0l.586.586a1 1 0 001.414 0l.586-.586a1 1 0 011.414 0L17 6v13m-8 0h8M5 21h14"></path></svg>,
              quizzes: <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>,
              recommendations: <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path></svg>,
              notifications: <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"></path></svg>,
              leaderboard: <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path></svg>,
              profile: <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>,
              logout: <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg>,
          };

          const viewTitles = {
            dashboard: 'Dashboard',
            achievements: 'My Achievements',
            quizzes: 'Practice Quizzes',
            recommendations: 'For You ‚ú®',
            notifications: 'Notifications',
            leaderboard: 'Leaderboard',
            profile: 'My Profile'
          };

          return (
              <div className="min-h-screen flex bg-slate-900 text-slate-200 font-sans">
                  {/* Sidebar */}
                  <aside className="w-64 bg-slate-800 p-4 flex flex-col flex-shrink-0 border-r border-slate-700/50">
                      <div className="text-2xl font-bold mb-10 text-white px-2">Skillera</div>
                      <nav className="flex-grow">
                          <ul className="space-y-2">
                              <NavItem icon={icons.dashboard} label="Dashboard" viewName="dashboard" />
                              <NavItem icon={icons.add} label="Add Achievement" isAction={true} action={() => setIsModalOpen(true)} />
                              <NavItem icon={icons.achievements} label="My Achievements" viewName="achievements" />
                              <NavItem icon={icons.quizzes} label="Practice Quizzes" viewName="quizzes" />
                              <NavItem icon={icons.recommendations} label="Recommendations" viewName="recommendations" />
                              <NavItem icon={icons.leaderboard} label="Leaderboard" viewName="leaderboard" />
                              <NavItem icon={icons.notifications} label="Notifications" viewName="notifications" />
                          </ul>
                      </nav>
                      <div className="border-t border-slate-700 pt-2">
                          <ul className="space-y-2">
                            <NavItem icon={icons.profile} label="My Profile" viewName="profile" />
                            <NavItem icon={icons.logout} label="Logout" isAction={true} action={handleLogout} />
                          </ul>
                      </div>
                  </aside>

                  {/* Main Content */}
                  <div className="flex-1 flex flex-col overflow-hidden">
                      <header className="bg-slate-800/50 backdrop-blur-sm shadow-md p-4 flex justify-between items-center border-b border-slate-700/50">
                           <h1 className="text-2xl font-bold">{viewTitles[activeView]}</h1>
                           <div className="flex items-center gap-4">
                               <span className="text-right text-sm">
                                   <div className="font-semibold text-white">{profile.full_name}</div>
                                   <div className="text-slate-400">{profile.class || 'Student'}</div>
                               </span>
                               <img src={profile.avatar_url || `https://ui-avatars.com/api/?name=${profile.full_name}&background=0F172A&color=fff`} alt="Avatar" className="w-10 h-10 rounded-full object-cover bg-slate-700"/>
                           </div>
                      </header>
      
                      <main className="p-8 flex-grow overflow-y-auto">
                            {activeView === 'dashboard' && <DashboardHome />}
                            {activeView === 'achievements' && <MyAchievementsList achievements={myAchievements} loading={loading} />}
                            {activeView === 'quizzes' && <QuizComponent />}
                            {activeView === 'recommendations' && <RecommendationsComponent profile={profile} setActiveView={setActiveView} />}
                            {activeView === 'notifications' && <NotificationsComponent />}
                            {activeView === 'leaderboard' && <LeaderboardComponent />}
                            {activeView === 'profile' && <ProfileEditor profile={profile} onProfileUpdate={updateProfile} />}
                      </main>
                  </div>

                  <AchievementModal 
                    isOpen={isModalOpen} 
                    onClose={() => setIsModalOpen(false)} 
                    onSubmit={handleSubmit} 
                    newAchievement={newAchievement} 
                    setNewAchievement={setNewAchievement}
                    isSubmitting={isSubmitting}
                    error={submissionError}
                  />
              </div>
          );
      }
      
      // --- Admin Components ---
       const AdminDashboard = ({ session, handleLogout }) => {
          const [activeTab, setActiveTab] = useState('approval');
          const [achievements, setAchievements] = useState([]);
          const [loading, setLoading] = useState(true);

          const fetchAchievements = useCallback(async () => {
            setLoading(true);
            const { data, error } = await supabaseClient
                .from('achievements')
                .select(`*, profiles ( full_name, class )`)
                .order('created_at', { ascending: false });
            
            if (error) {
                console.error('Error fetching achievements:', error.message);
            } else {
                const formattedData = data.map(ach => ({
                    ...ach, 
                    studentName: ach.profiles?.full_name || 'Unknown Student',
                    studentClass: ach.profiles?.class || 'N/A',
                }));
                setAchievements(formattedData);
            }
            setLoading(false);
          }, []);

          useEffect(() => { fetchAchievements(); }, [fetchAchievements]);

          const handleAchievementStatus = async (achievementId, status) => {
              const achievement = achievements.find(a => a.id === achievementId);
              if (!achievement) return;

              const { error } = await supabaseClient.from('achievements').update({ status }).eq('id', achievementId);
              if (error) console.error('Error updating status:', error.message);
              else fetchAchievements();
          };

          const pendingAchievements = achievements.filter(ach => ach.status === 'pending');
          const reviewedAchievements = achievements.filter(ach => ach.status !== 'pending');
          const achievementsByStudent = achievements.reduce((acc, ach) => {
              const studentKey = ach.studentName || 'Unknown';
              if (!acc[studentKey]) acc[studentKey] = [];
              acc[studentKey].push(ach);
              return acc;
          }, {});
          
          const ICONS = {
              check: <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M5 13l4 4L19 7"></path></svg>,
              cross: <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M6 18L18 6M6 6l12 12"></path></svg>,
              checkCircle: <svg className="w-5 h-5 text-green-400" fill="currentColor" viewBox="0 0 20 20"><path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clipRule="evenodd"></path></svg>,
              crossCircle: <svg className="w-5 h-5 text-red-400" fill="currentColor" viewBox="0 0 20 20"><path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clipRule="evenodd"></path></svg>,
          };
          
          const StatCard = ({ title, value, icon }) => (
            <div className="bg-slate-900/70 p-6 rounded-xl border border-slate-700/50 flex items-center gap-6">
                <div className="bg-slate-800 p-3 rounded-full">{icon}</div>
                <div>
                    <p className="text-slate-400 text-sm font-medium">{title}</p>
                    <p className="text-3xl font-bold text-white">{value}</p>
                </div>
            </div>
          );

          const TabButton = ({ isActive, onClick, children }) => ( 
            <button 
              onClick={onClick} 
              className={`px-5 py-3 text-base font-semibold rounded-t-lg transition-all duration-300 relative ${isActive ? 'text-white' : 'text-slate-400 hover:text-white'}`}>
                {children}
                {isActive && <div className="absolute bottom-0 left-0 right-0 h-1 bg-teal-400 rounded-full"></div>}
            </button>
          );
          
          const getStatusBadge = (status) => {
              switch (status) {
                  case 'approved': return <span className="text-xs font-bold py-1 px-3 rounded-full bg-green-500/20 text-green-300 border border-green-500/30">Approved</span>;
                  case 'rejected': return <span className="text-xs font-bold py-1 px-3 rounded-full bg-red-500/20 text-red-300 border border-red-500/30">Rejected</span>;
                  case 'pending': return <span className="text-xs font-bold py-1 px-3 rounded-full bg-yellow-500/20 text-yellow-300 border border-yellow-500/30">Pending</span>;
                  default: return null;
              }
          };

          const AcademicPerformanceChart = ({ achievements }) => {
              const academicData = achievements
                  .filter(ach => ach.type === 'Academic' && ach.status === 'approved')
                  .reduce((acc, ach) => {
                      const className = ach.studentClass || 'N/A';
                      acc[className] = (acc[className] || 0) + (ach.points || 0);
                      return acc;
                  }, {});

              const chartData = Object.entries(academicData)
                  .filter(([className, points]) => className !== 'N/A' && points > 0)
                  .sort((a, b) => b[1] - a[1]);

              if (chartData.length === 0) {
                  return (
                    <div className="bg-slate-900 p-6 rounded-xl border border-slate-800 h-full flex flex-col">
                        <h2 className="text-xl font-bold mb-6">Academic Performance by Class</h2>
                        <div className="flex-grow flex items-center justify-center text-center text-slate-500 py-8">No academic data available to display.</div>
                    </div>
                  );
              }

              const maxPoints = Math.max(1, ...chartData.map(d => d[1]));

              return (
                  <div className="bg-slate-900 p-6 rounded-xl border border-slate-800 h-full">
                      <h2 className="text-xl font-bold mb-6">Academic Performance by Class (Total Points)</h2>
                      <div className="space-y-4">
                          {chartData.map(([className, points]) => (
                              <div key={className} className="grid grid-cols-4 gap-4 items-center">
                                  <span className="text-sm font-medium text-slate-300 col-span-1 truncate">{className}</span>
                                  <div className="col-span-3 bg-slate-800 rounded-full h-6 flex items-center">
                                      <div
                                          className="bg-gradient-to-r from-teal-500 to-cyan-500 h-6 rounded-full flex items-center justify-end pr-2"
                                          style={{ width: `${(points / maxPoints) * 100}%` }}
                                      >
                                          <span className="text-sm font-bold text-white">{points}</span>
                                      </div>
                                  </div>
                              </div>
                          ))}
                      </div>
                  </div>
              );
          };

          const CoCurricularChart = ({ achievements }) => {
              const coCurricularTypes = ['Sports', 'Cultural', 'Arts', 'Social Service', 'Other'];
              const coCurricularData = achievements
                  .filter(ach => coCurricularTypes.includes(ach.type) && ach.status === 'approved')
                  .reduce((acc, ach) => {
                      acc[ach.type] = (acc[ach.type] || 0) + 1;
                      return acc;
                  }, {});

              const chartData = Object.entries(coCurricularData).sort((a, b) => b[1] - a[1]);

              if (chartData.length === 0) {
                  return (
                     <div className="bg-slate-900 p-6 rounded-xl border border-slate-800 h-full flex flex-col">
                        <h2 className="text-xl font-bold mb-6">Co-Curricular Activities</h2>
                        <div className="flex-grow flex items-center justify-center text-center text-slate-500 py-8">No co-curricular data available to display.</div>
                    </div>
                  );
              }
              
              const maxCount = Math.max(1, ...chartData.map(d => d[1]));
              const colors = {
                  'Sports': 'from-blue-500 to-sky-500',
                  'Cultural': 'from-purple-500 to-violet-500',
                  'Arts': 'from-pink-500 to-rose-500',
                  'Social Service': 'from-orange-500 to-amber-500',
                  'Other': 'from-slate-500 to-gray-500',
              };

              return (
                  <div className="bg-slate-900 p-6 rounded-xl border border-slate-800 h-full">
                      <h2 className="text-xl font-bold mb-6">Co-Curricular Activities (Count)</h2>
                      <div className="space-y-4">
                          {chartData.map(([type, count]) => (
                              <div key={type} className="grid grid-cols-4 gap-4 items-center">
                                  <span className="text-sm font-medium text-slate-300 col-span-1">{type}</span>
                                  <div className="col-span-3 bg-slate-800 rounded-full h-6 flex items-center">
                                      <div
                                          className={`bg-gradient-to-r ${colors[type] || colors['Other']} h-6 rounded-full flex items-center justify-end pr-2`}
                                          style={{ width: `${(count / maxCount) * 100}%` }}
                                      >
                                          <span className="text-sm font-bold text-white">{count}</span>
                                      </div>
                                  </div>
                              </div>
                          ))}
                      </div>
                  </div>
              );
          };

          const NotificationsManager = () => {
              return (
                <div className="bg-slate-900 p-8 rounded-xl border-2 border-dashed border-yellow-500/50 text-center">
                    <h2 className="text-2xl font-bold text-yellow-400 mb-2">Database Configuration Needed</h2>
                    <p className="text-slate-300 max-w-2xl mx-auto">
                        The 'Notifications' feature requires a database table named <code className="bg-slate-700 text-sm font-mono p-1 rounded">notifications</code> to be created in your Supabase project.
                    </p>
                    <p className="text-slate-400 mt-4">
                        Please create the table with columns like <code className="bg-slate-700 text-sm font-mono p-1 rounded">id</code>, <code className="bg-slate-700 text-sm font-mono p-1 rounded">created_at</code>, <code className="bg-slate-700 text-sm font-mono p-1 rounded">title</code>, and <code className="bg-slate-700 text-sm font-mono p-1 rounded">content</code> to enable this feature.
                    </p>
                </div>
              );
          };

          return (
               <div className="min-h-screen bg-slate-950 text-slate-200 font-sans">
                  <header className="bg-slate-900 shadow-md p-4 px-8 flex justify-between items-center sticky top-0 z-10 border-b border-slate-800">
                       <h1 className="text-2xl font-bold text-white tracking-wider">ADMIN DASHBOARD</h1>
                       <button onClick={handleLogout} className="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-5 rounded-lg transition-colors duration-300">Logout</button>
                  </header>
                  <main className="p-8">
                    {loading ? <div className="text-center py-10">Loading dashboard...</div> : <>
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-10">
                            <StatCard title="Pending Approvals" value={pendingAchievements.length} icon={<svg className="w-8 h-8 text-yellow-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>} />
                            <StatCard title="Total Reviewed" value={reviewedAchievements.length} icon={<svg className="w-8 h-8 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>} />
                            <StatCard title="Total Achievements" value={achievements.length} icon={<svg className="w-8 h-8 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 19V6l1.293-1.293a1 1 0 011.414 0l.586.586a1 1 0 001.414 0l.586-.586a1 1 0 011.414 0L17 6v13m-8 0h8M5 21h14"></path></svg>} />
                            <StatCard title="Total Students" value={Object.keys(achievementsByStudent).length} icon={<svg className="w-8 h-8 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>} />
                        </div>

                        <div className="mb-10 grid grid-cols-1 lg:grid-cols-2 gap-8">
                            <AcademicPerformanceChart achievements={achievements} />
                            <CoCurricularChart achievements={achievements} />
                        </div>

                      <div className="border-b border-slate-800 mb-6">
                           <TabButton isActive={activeTab === 'approval'} onClick={() => setActiveTab('approval')}>Approval Workflow</TabButton>
                           <TabButton isActive={activeTab === 'allAchievements'} onClick={() => setActiveTab('allAchievements')}>All Achievements</TabButton>
                           <TabButton isActive={activeTab === 'notifications'} onClick={() => setActiveTab('notifications')}>Notifications</TabButton>
                      </div>

                      {activeTab === 'approval' && (
                          <div className="grid grid-cols-1 lg:grid-cols-2 gap-8 items-start">
                              <div className="bg-slate-900 p-6 rounded-xl border border-slate-800 space-y-4">
                                <h2 className="text-xl font-bold mb-4">Pending Approval ({pendingAchievements.length})</h2>
                                 {pendingAchievements.length > 0 ? (
                                     <div className="space-y-6">
                                         {pendingAchievements.map(ach => (
                                           <div key={ach.id} className="bg-slate-800/50 p-4 rounded-lg border border-slate-700 hover:border-teal-500/50 transition-all duration-300 shadow-lg hover:shadow-teal-500/10">
                                             <h3 className="text-lg font-bold text-teal-400 mb-2">{ach.studentName}</h3>
                                             <div className="flex flex-col md:flex-row gap-4">
                                               <div className="flex-1">
                                                 <p className="font-semibold text-white">{ach.name}</p>
                                                 <div className="flex items-center flex-wrap gap-x-3 text-sm text-slate-400 mt-1">
                                                   <span>{ach.type}</span> &bull; <span className="font-semibold text-blue-400">{ach.level}</span> {ach.position && `‚Ä¢ ${ach.position}`}
                                                 </div>
                                               </div>
                                               <div className="flex flex-col items-start md:items-end justify-between gap-3">
                                                   {ach.proof_url ? <a href={ach.proof_url} target="_blank" rel="noopener noreferrer"><img src={ach.proof_url} alt="Proof" className="w-20 h-20 object-cover rounded-md shadow-lg mb-2 border-2 border-slate-600 hover:border-blue-400 transition"/></a> : <div className="w-20 h-20 bg-slate-700 rounded-md flex items-center justify-center text-xs text-slate-500">No Proof</div>}
                                                   <div className="flex gap-2">
                                                      <button onClick={() => handleAchievementStatus(ach.id, 'approved')} className="bg-green-500/20 hover:bg-green-500/40 text-green-300 font-bold py-2 px-3 rounded-md text-sm flex items-center gap-1.5 transition-colors">{ICONS.check} Approve</button>
                                                      <button onClick={() => handleAchievementStatus(ach.id, 'rejected')} className="bg-red-500/20 hover:bg-red-500/40 text-red-300 font-bold py-2 px-3 rounded-md text-sm flex items-center gap-1.5 transition-colors">{ICONS.cross} Reject</button>
                                                   </div>
                                               </div>
                                             </div>
                                           </div>
                                         ))}
                                     </div>
                                 ) : <p className="text-slate-500 py-4 text-center">No achievements are pending approval.</p>}
                             </div>

                             <div className="bg-slate-900 p-6 rounded-xl border border-slate-800">
                                 <h2 className="text-xl font-bold mb-4">Reviewed Achievements ({reviewedAchievements.length})</h2>
                                 {reviewedAchievements.length > 0 ? (
                                     <ul className="space-y-3">
                                         {reviewedAchievements.map(ach => (
                                             <li key={ach.id} className="bg-slate-800/50 p-4 rounded-md flex justify-between items-center gap-3 border border-slate-800">
                                                 <div className="flex items-center gap-3">
                                                    {ach.status === 'approved' ? ICONS.checkCircle : ICONS.crossCircle}
                                                     <div>
                                                         <h4 className="font-semibold text-white">{ach.name} <span className="text-sm font-normal text-slate-400">({ach.studentName})</span></h4>
                                                         <div className="text-sm text-slate-500">{ach.type} &bull; {ach.level}</div>
                                                     </div>
                                                 </div>
                                             </li>
                                         ))}
                                     </ul>
                                 ) : <p className="text-slate-500 py-4 text-center">No achievements have been reviewed yet.</p>}
                             </div>
                          </div>
                      )}
                      
                      {activeTab === 'allAchievements' && (
                          <div className="bg-slate-900 p-6 rounded-xl border border-slate-800">
                              <h2 className="text-xl font-bold mb-4">All Student Achievements</h2>
                              {Object.keys(achievementsByStudent).length > 0 ? (
                                  <div className="space-y-6">
                                      {Object.entries(achievementsByStudent).map(([studentName, achievements]) => (
                                          <div key={studentName} className="bg-slate-800/50 p-4 rounded-lg border border-slate-800">
                                              <h3 className="text-xl font-bold text-teal-400 mb-3">{studentName}</h3>
                                              <ul className="space-y-3">
                                                  {achievements.map(ach => (
                                                      <li key={ach.id} className="flex justify-between items-center gap-3 border-b border-slate-800 last:border-b-0 pb-3 last:pb-0">
                                                          <div>
                                                              <p className="font-semibold text-white">{ach.name}</p>
                                                              <div className="flex items-center flex-wrap gap-x-3 text-sm text-slate-400 mt-1">
                                                                <span>{ach.type}</span> &bull; <span className="font-semibold text-blue-400">{ach.level}</span>
                                                                {ach.status === 'approved' && getPointsForLevel(ach.level) > 0 && <span className="font-bold text-teal-400">({getPointsForLevel(ach.level)} pts)</span>}
                                                                {ach.proof_url && <span>&bull;</span>}
                                                                {ach.proof_url && <a href={ach.proof_url} target="_blank" rel="noopener noreferrer" className="text-blue-400 hover:underline">View Proof</a>}
                                                              </div>
                                                          </div>
                                                          {getStatusBadge(ach.status)}
                                                      </li>
                                                  ))}
                                              </ul>
                                          </div>
                                      ))}
                                  </div>
                              ) : <p className="text-slate-500 py-4 text-center">No achievements have been submitted by any student yet.</p>}
                          </div>
                      )}
                      {activeTab === 'notifications' && <NotificationsManager />}
                      </>}
                  </main>
              </div>
          );
      }
      
      // --- Public Portfolio ---
      const PublicPortfolio = ({ userId }) => {
        const [profile, setProfile] = useState(null);
        const [achievements, setAchievements] = useState({});
        const [loading, setLoading] = useState(true);
        const [error, setError] = useState('');

        useEffect(() => {
            if (!userId) {
                setError('No user specified.');
                setLoading(false);
                return;
            }

            const fetchData = async () => {
                setLoading(true);
                setError('');

                const { data: profileData, error: profileError } = await supabaseClient
                    .from('profiles')
                    .select('full_name, class, avatar_url, skills')
                    .eq('id', userId)
                    .single();

                if (profileError || !profileData) {
                    setError('Profile not found or could not be loaded.');
                    setLoading(false);
                    return;
                }
                setProfile(profileData);

                const { data: achievementsData, error: achievementsError } = await supabaseClient
                    .from('achievements')
                    .select('name, type, level, position, proof_url')
                    .eq('student_id', userId)
                    .eq('status', 'approved')
                    .order('created_at', { ascending: false });

                if (achievementsError) {
                    console.error('Error fetching achievements:', achievementsError.message);
                    setError('Could not load achievements.');
                } else {
                    const grouped = achievementsData.reduce((acc, ach) => {
                        const type = ach.type || 'Other';
                        if (!acc[type]) acc[type] = [];
                        acc[type].push(ach);
                        return acc;
                    }, {});
                    setAchievements(grouped);
                }
                setLoading(false);
            };

            fetchData();
        }, [userId]);

        if (loading) return <div className="min-h-screen flex items-center justify-center"><p>Loading portfolio...</p></div>;
        if (error) return <div className="min-h-screen flex items-center justify-center"><p className="text-red-400">{error}</p></div>;

        return (
            <div className="min-h-screen bg-slate-900 text-slate-200 antialiased font-sans">
                <main className="container mx-auto p-4 md:p-8">
                    {profile && (
                        <header className="text-center mb-12 pt-8">
                            <div className="w-40 h-40 mx-auto rounded-full bg-slate-700 mb-6 overflow-hidden border-4 border-slate-600 shadow-lg">
                                {profile.avatar_url ? (
                                    <img src={profile.avatar_url} alt="Profile" className="w-full h-full object-cover" />
                                ) : (
                                    <svg className="w-32 h-32 text-slate-500 m-4" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fillRule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clipRule="evenodd"></path></svg>
                                )}
                            </div>
                            <h1 className="text-4xl md:text-5xl font-bold text-white tracking-tight">{profile.full_name}</h1>
                            {profile.class && <p className="text-xl text-slate-400 mt-2">{profile.class}</p>}
                            {profile.skills && (
                                <div className="mt-4 max-w-2xl mx-auto">
                                    <div className="flex flex-wrap justify-center gap-2">
                                        {profile.skills.split(',').map(skill => skill.trim()).filter(Boolean).map((skill, index) => (
                                            <span key={index} className="bg-teal-500/20 text-teal-300 px-3 py-1 rounded-full text-sm font-medium">
                                                {skill}
                                            </span>
                                        ))}
                                    </div>
                                </div>
                            )}
                        </header>
                    )}

                    {Object.keys(achievements).length > 0 ? (
                        <div className="space-y-10">
                            {Object.entries(achievements).map(([type, achList]) => (
                                <section key={type}>
                                    <h2 className="text-3xl font-bold mb-6 border-b-2 border-slate-700 pb-2 text-teal-400">{type}</h2>
                                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                        {achList.map((ach, index) => (
                                            <div key={index} className="bg-slate-800 p-6 rounded-lg shadow-lg hover:shadow-xl hover:-translate-y-1 transition-all duration-300">
                                                <h3 className="text-xl font-bold text-white mb-2">{ach.name}</h3>
                                                <div className="flex items-center flex-wrap gap-x-3 text-sm text-slate-400 mb-4">
                                                    <span className="font-semibold text-blue-400">{ach.level}</span>
                                                    {ach.position && <span>&bull;</span>}
                                                    {ach.position && <span className="font-medium text-slate-300">{ach.position}</span>}
                                                </div>
                                                {ach.proof_url && (
                                                    <a href={ach.proof_url} target="_blank" rel="noopener noreferrer" className="inline-block mt-2 bg-slate-700 hover:bg-slate-600 text-white font-semibold py-2 px-4 rounded-md text-sm transition-colors">
                                                        View Certificate
                                                    </a>
                                                )}
                                            </div>
                                        ))}
                                    </div>
                                </section>
                            ))}
                        </div>
                    ) : (
                        <div className="text-center py-16">
                            <p className="text-slate-500 text-lg">This student has not published any achievements yet.</p>
                        </div>
                    )}
                </main>
                <footer className="text-center py-8 mt-12 border-t border-slate-800">
                    <p className="text-slate-500">Powered by Skillera</p>
                </footer>
            </div>
        );
      };
      
      // --- App Component ---
      const App = () => {
          const [view, setView] = useState('auth');
          const [role, setRole] = useState('student');
          const [session, setSession] = useState(null);
          const [profile, setProfile] = useState(null);
          const [loadingProfile, setLoadingProfile] = useState(true);
          const [portfolioUserId, setPortfolioUserId] = useState(null);

          useEffect(() => {
              const urlParams = new URLSearchParams(window.location.search);
              const userId = urlParams.get('portfolio');
              
              const getSession = async () => {
                if (userId) {
                    setPortfolioUserId(userId);
                    setView('portfolio');
                    setLoadingProfile(false);
                    return;
                }
                const { data: { session } } = await supabaseClient.auth.getSession();
                setSession(session);
                if (!session) {
                  setView('schoolHome');
                }
                setLoadingProfile(false);
              };
              getSession();

              const { data: { subscription } } = supabaseClient.auth.onAuthStateChange(
                  (_event, session) => {
                      if (!window.location.search.includes('portfolio=')) {
                        setSession(session);
                      }
                  }
              );
              return () => subscription.unsubscribe();
          }, []);

          useEffect(() => {
            const fetchProfile = async () => {
                if (!session?.user) {
                    setProfile(null);
                    setLoadingProfile(false);
                    return;
                }

                setLoadingProfile(true);
                const { data: profileData, error } = await supabaseClient
                    .from('profiles')
                    .select('*')
                    .eq('id', session.user.id)
                    .single();

                if (profileData) {
                    setProfile(profileData);
                    setLoadingProfile(false);
                } else if (error) {
                    console.log(`No profile found for user ${session.user.id}. Creating a new one.`);
                    const fullNameFromMetadata = session.user.user_metadata?.full_name;
                    
                    const { data: newProfile, error: insertError } = await supabaseClient
                        .from('profiles')
                        .insert({
                            id: session.user.id,
                            full_name: fullNameFromMetadata || session.user.email?.split('@')[0] || 'New User',
                            role: 'student' 
                        })
                        .select()
                        .single();

                    if (insertError) {
                        console.error("Failed to create profile:", insertError.message);
                        setProfile(null);
                    } else {
                        setProfile(newProfile);
                    }
                    setLoadingProfile(false);
                }
            };
            
            if (!portfolioUserId) {
                fetchProfile();
            }
          }, [session, portfolioUserId]);
          
          const handleLogout = async () => {
              await supabaseClient.auth.signOut();
              setView('schoolHome');
              setProfile(null);
              setSession(null);
              // Clear portfolio view
              const url = new URL(window.location.href);
              url.searchParams.delete('portfolio');
              window.history.pushState({}, '', url);
          };

          const updateProfile = async (updatedProfile) => {
              if (!session?.user) return;
              
              let avatarUrl = updatedProfile.avatar_url;
              if (updatedProfile.newAvatarFile) {
                  const file = updatedProfile.newAvatarFile;
                  const filePath = `${session.user.id}/avatar.${file.name.split('.').pop()}`;
                  avatarUrl = await uploadFile(file, 'avatars', filePath);
              }

              const { error } = await supabaseClient.from('profiles').upsert({
                  id: session.user.id,
                  full_name: updatedProfile.full_name,
                  class: updatedProfile.class,
                  skills: updatedProfile.skills,
                  avatar_url: avatarUrl
              });

              if (error) {
                  console.error('Error updating profile:', error.message);
                  alert(`Error: ${error.message}`);
              } else {
                  setProfile(prev => prev ? ({...prev, ...updatedProfile, avatar_url: avatarUrl}) : null);
              }
          };
          
          if (loadingProfile) {
            return <div className="min-h-screen flex items-center justify-center"><p>Loading...</p></div>;
          }

          if (session && profile) {
              if (profile.role === 'admin') {
                  return <AdminDashboard session={session} handleLogout={handleLogout} />;
              }
              return <StudentDashboard 
                        session={session} 
                        profile={profile}
                        handleLogout={handleLogout}
                        updateProfile={updateProfile}
                     />
          }
          
          switch (view) {
              case 'portfolio': return <PublicPortfolio userId={portfolioUserId} />;
              case 'login': return <LoginForm role={role} setView={setView} />;
              case 'register': return <RegisterForm setView={setView} />;
              case 'schoolHome': return <SchoolWebsite setView={setView} setRole={setRole} />;
              case 'auth':
              default: return <AuthPage setView={setView} />;
          }
      };

      // --- Render Application ---
      const rootElement = document.getElementById('root');
      if (rootElement) {
          const root = createRoot(rootElement);
          root.render(<StrictMode><App /></StrictMode>);
      } else {
          console.error("Could not find root element to mount to");
      }
    </script>
</body>
</html>